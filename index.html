<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تمرين اللغة الإنجليزية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --bg-color: #1a202c; /* Dark Blue-Gray */
            --primary-color: #2d3748; /* Darker Blue-Gray */
            --text-color: #E2E8F0; /* Light Gray */
            --highlight-color: #4299E1; /* Bright Blue */
            --highlight-glow: rgba(66, 153, 225, 0.5);
            --accent-color: #38B2AC; /* Teal */
            --tile-bg: #2d3748;
            --tile-border: #4A5568;
            --font-family-ar: 'Tajawal', sans-serif;
            --font-family-en: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-family-ar);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--primary-color);
            border: 1px solid var(--tile-border);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        .hidden {
            display: none !important;
        }
        
        .highlight-text {
            color: var(--highlight-color);
            text-shadow: 0 0 8px var(--highlight-glow);
        }
        
        .highlight {
            color: var(--highlight-color);
            font-weight: 700;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--tile-bg);
            border: 1px solid var(--tile-border);
            color: var(--highlight-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        /* --- Screens --- */
        #start-screen h1, #selection-screen h2, #word-selection-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 25px;
        }
        
        .btn {
            background: linear-gradient(145deg, var(--accent-color), var(--highlight-color));
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-family: var(--font-family-ar);
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(66, 153, 225, 0.2);
            margin-top: 20px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(66, 153, 225, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }

        /* Word Selection Screen */
        #word-list {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .word-card {
            background-color: var(--tile-bg);
            border: 2px solid var(--tile-border);
            border-radius: 15px;
            padding: 30px 50px;
            font-size: 2rem;
            font-family: var(--font-family-en);
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.3s;
        }
        .word-card:hover {
            transform: translateY(-5px);
            border-color: var(--highlight-color);
        }

        /* Selection Screen */
        #selection-screen { justify-content: flex-start; padding-top: 5vh; }
        #sentence-selection-list {
            width: 100%; max-width: 600px; height: 65vh; overflow-y: auto;
            background: var(--bg-color); padding: 10px; border-radius: 15px; border: 1px solid var(--tile-border);
        }
        .sentence-choice {
            display: flex; align-items: center; padding: 12px 15px; cursor: pointer;
            border-radius: 8px; transition: background-color 0.2s;
        }
        .sentence-choice:hover { background-color: rgba(66, 153, 225, 0.1); }
        .sentence-choice input[type="checkbox"] { display: none; }
        .sentence-choice .custom-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--highlight-color); border-radius: 5px;
            margin-left: 15px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s;
        }
        .sentence-choice .custom-checkbox .checkmark {
            width: 10px; height: 10px; background-color: var(--highlight-color); border-radius: 2px;
            transform: scale(0); transition: transform 0.2s;
        }
        .sentence-choice input[type="checkbox"]:checked + .custom-checkbox .checkmark { transform: scale(1); }
        .sentence-choice-text { flex-grow: 1; text-align: right; font-family: var(--font-family-en); direction: ltr; }
        .sentence-count-input {
            width: 70px; background-color: var(--primary-color); border: 1px solid var(--tile-border);
            color: var(--text-color); border-radius: 5px; padding: 5px; text-align: center; margin-right: 10px;
        }
        .selection-actions { margin-top: 15px; }
        .selection-actions button {
            background: none; border: 1px solid var(--highlight-color); color: var(--highlight-color);
            padding: 8px 15px; font-size: 0.9rem; margin: 0 5px; border-radius: 20px; cursor: pointer;
        }

        /* Practice Screen */
        #practice-screen h2 { font-size: 2rem; margin-bottom: 20px; }
        #practice-banner {
            width: 90%; max-width: 600px; min-height: 250px;
            border: 2px solid var(--highlight-color); border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 25px;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
            cursor: pointer;
        }
        #practice-banner.clicked {
            transform: scale(0.98);
            border-color: var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
        }
        #practice-context {
            font-family: var(--font-family-ar);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--accent-color);
            margin-bottom: 20px;
            padding: 5px 15px;
            background-color: rgba(56, 178, 172, 0.1);
            border-radius: 20px;
        }
        #practice-text-ar {
            font-family: var(--font-family-ar);
            font-size: 1.4rem;
            color: #A0AEC0; /* Lighter gray for translation */
            margin-bottom: 20px;
        }
        #practice-text-en {
            font-family: var(--font-family-en);
            font-size: 1.8rem;
            direction: ltr;
        }
        #practice-controls {
            display: flex; align-items: center; margin-top: 20px;
        }
        #practice-counter {
            font-size: 1.5rem; color: var(--highlight-color); min-width: 150px; text-align: left;
            font-family: var(--font-family-en);
        }
        #practice-next-btn {
            background: var(--tile-bg); border: 1px solid var(--tile-border); color: var(--highlight-color);
            width: 50px; height: 50px; border-radius: 50%; font-size: 2rem;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            margin-right: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h1 class="highlight-text">تمرين الإنجليزية</h1>
            <p>اختر الكلمة أو القاعدة ثم الجمل التي تريد التدرب عليها.</p>
            <button id="go-to-word-selection-btn" class="btn">ابدأ التمرين</button>
        </div>

        <!-- Word Selection Screen -->
        <div id="word-selection-screen" class="screen hidden">
            <div class="back-btn" id="back-to-start-from-word-select">→</div>
            <h2 class="highlight-text">اختر الدرس</h2>
            <div id="word-list">
                <div class="word-card" data-word="add">add</div>
                <div class="word-card" data-word="a_an">a / an</div>
                <!-- سيتم إضافة المزيد من الكلمات هنا مستقبلاً -->
            </div>
        </div>

        <!-- Selection Screen -->
        <div id="selection-screen" class="screen hidden">
            <div class="back-btn" id="back-to-word-select-from-sentence">→</div>
            <h2 class="highlight-text">اختر الجمل وعددها</h2>
            <div id="sentence-selection-list"></div>
            <div class="selection-actions">
                <button id="select-all-btn">اختر الكل</button>
                <button id="deselect-all-btn">إلغاء الكل</button>
            </div>
            <button id="start-practice-btn" class="btn">ابدأ التدريب</button>
        </div>
        
        <!-- Practice Screen -->
        <div id="practice-screen" class="screen hidden">
            <div class="back-btn" id="back-to-select-from-practice">→</div>
            <h2 class="highlight-text">التمرين</h2>
            <div id="practice-banner">
                <div id="practice-context"></div>
                <div id="practice-text-ar"></div>
                <div id="practice-text-en" class="highlight-text"></div>
            </div>
            <div id="practice-controls">
                <button id="practice-next-btn">تخطي</button>
                <div id="practice-counter">0 / 0</div>
            </div>
        </div>

        <!-- Session Complete Screen -->
        <div id="session-complete-screen" class="screen hidden">
             <h2 class="highlight-text">ممتاز!</h2>
             <p>لقد أتممت تمرينك المحدد. أحسنت صنعًا.</p>
             <button id="back-to-selection-from-complete" class="btn">تمرين جديد</button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const screens = {
                start: document.getElementById('start-screen'),
                wordSelection: document.getElementById('word-selection-screen'),
                selection: document.getElementById('selection-screen'),
                practice: document.getElementById('practice-screen'),
                sessionComplete: document.getElementById('session-complete-screen'),
            };
            
            const goToWordSelectionBtn = document.getElementById('go-to-word-selection-btn');
            const wordList = document.getElementById('word-list');
            const startPracticeBtn = document.getElementById('start-practice-btn');
            const selectAllBtn = document.getElementById('select-all-btn');
            const deselectAllBtn = document.getElementById('deselect-all-btn');
            
            const backToStartFromWordSelect = document.getElementById('back-to-start-from-word-select');
            const backToWordSelectFromSentence = document.getElementById('back-to-word-select-from-sentence');
            const backToSelectFromPractice = document.getElementById('back-to-select-from-practice');
            const backToSelectionFromComplete = document.getElementById('back-to-selection-from-complete');

            const sentenceSelectionList = document.getElementById('sentence-selection-list');
            const practiceBanner = document.getElementById('practice-banner');
            const practiceContext = document.getElementById('practice-context');
            const practiceTextAr = document.getElementById('practice-text-ar');
            const practiceTextEn = document.getElementById('practice-text-en');
            const practiceCounter = document.getElementById('practice-counter');
            const practiceNextBtn = document.getElementById('practice-next-btn');
            
            // --- Data Library ---
            const WORD_LIBRARY = {
                'add': [
                    { en: "I add sugar to my tea every morning.", ar: "أضيف السكر إلى الشاي كل صباح.", context: "المضارع البسيط", highlight: "add" },
                    { en: "She added salt to the soup.", ar: "هي أضافت الملح إلى الحساء.", context: "الماضي البسيط", highlight: "added" },
                    { en: "He will add your name to the list.", ar: "سوف يضيف اسمك إلى القائمة.", context: "المستقبل", highlight: "will add" },
                    { en: "They are adding more chairs to the room.", ar: "إنهم يضيفون المزيد من الكراسي إلى الغرفة.", context: "المضارع المستمر", highlight: "are adding" },
                    { en: "I don’t add pepper to food.", ar: "أنا لا أضيف الفلفل إلى الطعام.", context: "صيغة النفي", highlight: "don’t add" },
                    { en: "Did you add the eggs?", ar: "هل أضفت البيض؟", context: "صيغة السؤال", highlight: "Did you add" },
                    { en: "Add some cheese, please.", ar: "أضف بعض الجبن، من فضلك.", context: "صيغة الأمر", highlight: "Add" },
                    { en: "Sugar was added to the cake.", ar: "تمت إضافة السكر إلى الكعكة.", context: "مبني للمجهول", highlight: "was added" },
                    { en: "Let me add one more thing.", ar: "دعني أضف شيئًا آخر.", context: "عبارة شائعة", highlight: "add" },
                    { en: "If you add 2 and 3, you get 5.", ar: "إذا أضفت 2 و 3، تحصل على 5.", context: "سياق رياضي", highlight: "add" },
                    { en: "Can you add to the discussion?", ar: "هل يمكنك الإضافة إلى النقاش؟", context: "مع حرف جر", highlight: "add to" },
                    { en: "His jokes really add to the fun.", ar: "نكاته تضيف حقًا إلى المرح.", context: "استخدام مجازي", highlight: "add to" }
                ],
                'a_an': [
                    { en: "I have a book.", ar: "لدي كتاب. (استخدام عادي مع اسم مفرد)", context: "الأساسيات", highlight: "a" },
                    { en: "She ate an apple.", ar: "هي أكلت تفاحة. (استخدام عادي مع اسم مفرد)", context: "الأساسيات", highlight: "an" },
                    { en: "Do you have a pen?", ar: "هل لديك قلم؟ (في صيغة سؤال)", context: "في السؤال", highlight: "a" },
                    { en: "I don’t have a car.", ar: "ليس لدي سيارة. (مع النفي)", context: "في النفي", highlight: "a" },
                    { en: "He is a good teacher.", ar: "هو معلم جيد. (تأتي الأداة قبل الصفة ثم الاسم)", context: "مع الصفات", highlight: "a" },
                    { en: "It's an interesting story.", ar: "إنها قصة مثيرة للاهتمام. (تأتي الأداة قبل الصفة ثم الاسم)", context: "مع الصفات", highlight: "an" },
                    { en: "I’ll be back in a minute.", ar: "سأعود خلال دقيقة. (مع الزمن)", context: "قبل الأرقام", highlight: "a" },
                    { en: "She is a doctor.", ar: "هي طبيبة. (الوظائف تأخذ a/an)", context: "مع الوظائف", highlight: "a" },
                    { en: "He is an engineer.", ar: "هو مهندس. (الوظائف تأخذ a/an)", context: "مع الوظائف", highlight: "an" },
                    { en: "I need a lot of time.", ar: "أحتاج الكثير من الوقت. (عبارات تركيبية شائعة)", context: "في التعبيرات الشائعة", highlight: "a" },
                    { en: "That’s a bit strange.", ar: "هذا غريب بعض الشيء. (عبارات تركيبية شائعة)", context: "في التعبيرات الشائعة", highlight: "a" },
                    { en: "I’ll give you a hand.", ar: "سأساعدك. (عبارات تركيبية شائعة)", context: "في التعبيرات الشائعة", highlight: "a" },
                    { en: "He is a Muslim.", ar: "هو مسلم. (تستخدم للدلالة على هوية)", context: "قبل الجنسيات أو الأديان", highlight: "a" },
                    { en: "She is an American.", ar: "هي أمريكية. (تستخدم للدلالة على هوية)", context: "قبل الجنسيات أو الأديان", highlight: "an" },
                    { en: "He bought a phone.", ar: "هو اشترى هاتفًا. (واحد من مجموعة غير محددة)", context: "مع \"one of\" ضمنًا", highlight: "a" },
                    { en: "Gas costs $2 a litre.", ar: "يكلف الغاز دولارين للتر الواحد. (تعني \"لكل\" وحدة)", context: "مع وحدات القياس", highlight: "a" },
                    { en: "Once upon a time, there was a king.", ar: "كان يا ما كان، كان هناك ملك. (بداية القصص التقليدية)", context: "في القصص والسرد", highlight: "a" },
                    { en: "I heard an unusual noise.", ar: "سمعت ضوضاء غير عادية. (صوت يبدأ بحرف علة)", context: "مع الأصوات", highlight: "an" },
                    { en: "She is an honest person.", ar: "هي شخص أمين. (\"honest\" تبدأ بصوت علة)", context: "مع كلمة تبدأ بحرف ساكن لكن تُنطق بحرف علة", highlight: "an" },
                    { en: "He is a university student.", ar: "هو طالب جامعي. (\"university\" تبدأ بصوت ساكن /y/)", context: "مع كلمة تبدأ بحرف علة لكنها تُنطق بصوت ساكن", highlight: "a" },
                    { en: "What a beautiful day!", ar: "يا له من يوم جميل! (تعجب باستخدام a)", context: "مع exclamations", highlight: "a" }
                ]
            };

            // --- State ---
            let sessionCounters = {};
            let practiceList = [];
            let currentSentenceIndex = -1;
            let currentWordKey = null;

            // --- Audio ---
            let synth, clickSound;
            let voices = [];
            
            function initializeAudio() {
                if (Tone.context.state !== 'running') { Tone.start(); }
                synth = new Tone.Synth().toDestination();
                clickSound = () => synth.triggerAttackRelease("C5", "8n", Tone.now());
            }

            function loadVoices() {
                if ('speechSynthesis' in window) {
                    voices = window.speechSynthesis.getVoices();
                    if (voices.length === 0) {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                        };
                    }
                }
            }

            function speakSentence(text) {
                if ('speechSynthesis' in window && voices.length > 0) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const englishVoice = voices.find(voice => voice.lang.startsWith('en-US') || voice.lang.startsWith('en-GB'));
                    utterance.voice = englishVoice || voices.find(voice => voice.lang.startsWith('en-'));
                    utterance.lang = 'en-US';
                    utterance.rate = 0.6; 
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                }
            }

            // --- UI & Flow Management ---
            function showScreen(screenName) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                screens[screenName].classList.remove('hidden');
            }

            function populateSentenceSelection(wordKey) {
                currentWordKey = wordKey;
                const sentences = WORD_LIBRARY[wordKey];
                sentenceSelectionList.innerHTML = '';
                sentences.forEach((sentence, index) => {
                    const choiceDiv = document.createElement('label');
                    choiceDiv.className = 'sentence-choice';
                    choiceDiv.innerHTML = `
                        <input type="checkbox" value="${index}" checked>
                        <span class="custom-checkbox"><span class="checkmark"></span></span>
                        <span class="sentence-choice-text">${sentence.en}</span>
                        <input type="number" class="sentence-count-input" value="7" placeholder="العدد" min="1">
                    `;
                    sentenceSelectionList.appendChild(choiceDiv);
                });
            }
            
            // --- Practice Flow ---
            function startPracticeSession() {
                const selectedCheckboxes = sentenceSelectionList.querySelectorAll('input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('الرجاء اختيار جملة واحدة على الأقل لبدء التمرين.');
                    return;
                }

                practiceList = [];
                sessionCounters = {};
                const currentSentences = WORD_LIBRARY[currentWordKey];

                selectedCheckboxes.forEach(cb => {
                    const index = parseInt(cb.value);
                    const sentence = currentSentences[index];
                    const countInput = cb.closest('.sentence-choice').querySelector('.sentence-count-input');
                    const target = parseInt(countInput.value) || 7; 

                    sessionCounters[sentence.en] = {
                        target: target,
                        current: 0
                    };
                    
                    for(let i = 0; i < target; i++) {
                        practiceList.push(sentence);
                    }
                });
                
                shuffleArray(practiceList);
                
                currentSentenceIndex = -1; 
                showScreen('practice');
                displayNextSentence();
            }

            function displayNextSentence() {
                currentSentenceIndex++;
                if (currentSentenceIndex >= practiceList.length) {
                    showScreen('sessionComplete');
                    return;
                }
                
                const currentSentence = practiceList[currentSentenceIndex];
                
                const highlightedEn = currentSentence.en.replace(
                    new RegExp(currentSentence.highlight, 'g'), 
                    `<span class="highlight">${currentSentence.highlight}</span>`
                );

                practiceContext.textContent = currentSentence.context;
                practiceTextAr.textContent = currentSentence.ar;
                practiceTextEn.innerHTML = highlightedEn;
                updatePracticeCounter(currentSentence.en);
                
                speakSentence(currentSentence.en);
            }

            function updatePracticeCounter(sentenceEn) {
                const counter = sessionCounters[sentenceEn];
                practiceCounter.textContent = `${counter.current} / ${counter.target}`;
            }

            function handlePracticeClick() {
                if (currentSentenceIndex >= practiceList.length || currentSentenceIndex < 0) return;

                clickSound();
                practiceBanner.classList.add('clicked');
                setTimeout(() => {
                    practiceBanner.classList.remove('clicked');
                }, 150);

                const currentSentenceEn = practiceList[currentSentenceIndex].en;
                sessionCounters[currentSentenceEn].current++;
                
                displayNextSentence();
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // --- Event Listeners ---
            goToWordSelectionBtn.addEventListener('click', () => showScreen('wordSelection'));
            
            wordList.addEventListener('click', (e) => {
                const card = e.target.closest('.word-card');
                if (card) {
                    const wordKey = card.dataset.word;
                    populateSentenceSelection(wordKey);
                    showScreen('selection');
                }
            });
            
            startPracticeBtn.addEventListener('click', () => {
                if (!synth) initializeAudio();
                startPracticeSession();
            });

            practiceBanner.addEventListener('click', handlePracticeClick);
            practiceNextBtn.addEventListener('click', () => {
                clickSound();
                displayNextSentence();
            });
            
            selectAllBtn.addEventListener('click', () => {
                sentenceSelectionList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            });
            deselectAllBtn.addEventListener('click', () => {
                sentenceSelectionList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });

            backToStartFromWordSelect.addEventListener('click', () => showScreen('start'));
            backToWordSelectFromSentence.addEventListener('click', () => showScreen('wordSelection'));
            backToSelectFromPractice.addEventListener('click', () => showScreen('selection'));
            backToSelectionFromComplete.addEventListener('click', () => showScreen('selection'));
            
            // --- Initial Load ---
            loadVoices(); 
            showScreen('start');
        });
    </script>
</body>
</html>
